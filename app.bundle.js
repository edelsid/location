(()=>{"use strict";class e{formation(){this.formElement=document.createElement("div"),this.formElement.className="warning",this.formElement.innerHTML='\n      <text class="msg">Что-то пошло не так<br><br>\n      К сожалению, нам не удалось определить ваше местоположение. \n      Пожалуйста, дайте разрешение на использование геолокации, \n      либо введите координаты вручную.<br><br>\n      Широта и долгота через запятую (максимум 5 цифр после запятой):</text>\n      <input class="coord_print">\n      <ul class="form_btns">\n        <li class="form_btn decline">Отмена</li>\n        <li class="form_btn accept" type="submit">Ок</li>\n      </ul>'}static validateForm(e){if(!e)return!1;if(!e.includes(","))return!1;const t=/^-?[0-9]{1,2}\.[0-9]{1,5}$/,n=e.replace(/[\[\]]+/g,"").replace(/\s/g,"").split(",");return!(n.length>2)&&(!(!t.test(n[0])||!t.test(n[1]))&&{lat:n[0],long:n[1]})}}class t{constructor(e,t,n,s){this.text=e,this.coordinates=t,this.date=n,this.loaded=s}formation(){const e=document.createElement("li");return e.className="message",e.innerHTML=`\n      <span class="mark"></span>\n      <div class="msg_area">\n         <text class="text">${this.text}</text>\n         <text class="time">${this.date}</text>\n      </div>\n      <div class="coord">${this.coordinates}</div>`,this.loaded&&(e.innerHTML=this.loaded),e}}class n{static getCoord(t,s,r){navigator.geolocation&&navigator.geolocation.getCurrentPosition((e=>{const t=`${e.coords.latitude.toFixed(5)}, ${e.coords.longitude.toFixed(5)}`;n.renderMessage(s,r,t,null),n.saveState(s)}),(()=>{const o=new e;o.formation(),t.appendChild(o.formElement),n.formEvents(o,s,r)}))}static formEvents(e,t,s){e.formElement.querySelector(".decline").addEventListener("click",(t=>{t.preventDefault(),e.formElement.remove()})),e.formElement.querySelector(".accept").addEventListener("click",(r=>{r.preventDefault();const o=e.formElement.querySelector(".coord_print"),i=e.constructor.validateForm(o.value);if(!i)return void alert("Ошибка! Введите координаты в правильном формате");const a=`${i.lat}, ${i.long}`;n.renderMessage(t,s,a,null),n.saveState(t),e.formElement.remove()}))}static getDate(){const e=new Date,t=e.getFullYear().toString().slice(-2),s=n.insertZeroes(e.getMonth()+1);return`${n.insertZeroes(e.getDate())}.${s}.${t} ${n.insertZeroes(e.getHours())}:${n.insertZeroes(e.getMinutes())}`}static insertZeroes(e){let t;return e<10?(t=`0${e}`,t):e}static renderMessage(e,s,r,o){let i;o||(i=n.getDate());const a=new t(s,r,i,o).formation();e.appendChild(a)}static saveState(e){localStorage.clear();const t={},n=Array.from(e.children);for(let e=0;e<n.length;e+=1)t[`key${e}`]=n[e].innerHTML;localStorage.setItem("state",JSON.stringify(t))}}const s=document.getElementById("root");new class{constructor(e){this.bindToDOM(e),this.view=new n}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e,this.area=document.querySelector(".messages"),this.input=document.querySelector(".print")}init(){this.loadState(),this.input.addEventListener("keydown",(e=>this.enterMessage(e)))}loadState(){const e=JSON.parse(localStorage.getItem("state"));if(e)for(const t of Object.values(e))this.view.constructor.renderMessage(this.area,0,0,t)}enterMessage(e){"Enter"===e.key&&(e.preventDefault(),this.input.value&&(this.renderMessage(this.input.value),this.input.value=""))}renderMessage(e){this.view.constructor.getCoord(this.container,this.area,e)}}(s).init()})();